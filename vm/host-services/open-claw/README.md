# Open Claw

Self-hosted AI agent framework. Runs directly on the VM host (not in Docker).

## Architecture

Open Claw consists of two systemd user services:

1. **openclaw-proxy** (port 19999) — OpenAI-compatible reverse proxy that flattens multimodal content arrays into plain strings before forwarding to the upstream API (`maestro.us.jingtao.fun`).
2. **openclaw-gateway** (port 18789) — The main Open Claw gateway that serves agent requests. Routes model calls through the local proxy.

```
Client → Gateway (:18789) → Proxy (:19999) → maestro.us.jingtao.fun
```

## Prerequisites

- Node.js (via nvm, fnm, or system package)
- npm with a global prefix configured (`~/.npm-global`)

## Installation

```bash
npm install -g openclaw
```

## Configuration

### Environment Variables

The following environment variables must be set (e.g., in `/etc/environment` via `vm/scripts/03-set-env.sh`):

| Variable | Description |
|---|---|
| `OPENCLAW_API_KEY` | API key for the upstream model provider |
| `OPENCLAW_GATEWAY_TOKEN` | Authentication token for gateway access (used in `openclaw.json`) |

### Symlinks

Configuration files in this repo are symlinked to their system locations so edits in either place stay in sync:

| Repo File | System Location |
|---|---|
| `openclaw.json` | `~/.openclaw/openclaw.json` |
| `openai-compat-proxy.js` | `~/.openclaw/openai-compat-proxy.js` |
| `systemd/openclaw-proxy.service` | `~/.config/systemd/user/openclaw-proxy.service` |

**Note:** `openclaw-gateway.service` is auto-generated by `openclaw gateway install` and is NOT symlinked. The `.example` file is stored here for reference only.

### Setup

Run the setup script to create symlinks and enable services:

```bash
./setup.sh
```

The script will:
- Validate that required environment variables are set
- Back up existing files before replacing with symlinks
- Create symlinks from system locations to repo files
- Reload systemd and enable/start both services

## Useful Commands

```bash
# Check service status
systemctl --user status openclaw-gateway openclaw-proxy

# View logs
journalctl --user -u openclaw-gateway -f
journalctl --user -u openclaw-proxy -f

# Restart services
systemctl --user restart openclaw-proxy
systemctl --user restart openclaw-gateway

# Update openclaw
npm update -g openclaw
openclaw gateway install   # regenerates gateway service file

# Enable lingering (services persist after logout)
sudo loginctl enable-linger "$USER"
```

## File Overview

```
open-claw/
├── README.md
├── setup.sh                               # Symlink + service setup
├── openclaw.json                          # Gateway config (symlinked)
├── openai-compat-proxy.js                 # Proxy script (symlinked)
└── systemd/
    ├── openclaw-gateway.service.example   # Reference only (auto-generated)
    └── openclaw-proxy.service             # Proxy unit file (symlinked)
```
