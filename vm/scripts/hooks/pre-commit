#!/usr/bin/env bash
set -euo pipefail

# Pre-commit hook: Sync OpenClaw config and scan for secrets with Gitleaks

# Load environment variables (not available in non-login shells like git hooks)
# shellcheck disable=SC1091
[[ -f /etc/environment ]] && set -a && source /etc/environment && set +a

SYSTEM_CONFIG="$HOME/.openclaw/openclaw.json"
REPO_CONFIG="vm/host-services/open-claw/openclaw.example.json"

# ==================== Auto-sync OpenClaw Config ====================

if [[ -f "$SYSTEM_CONFIG" ]] && git diff --cached --name-only | grep -q "$REPO_CONFIG\|^$"; then
  echo "üîÑ Syncing OpenClaw config from system to repo..."
  cp "$SYSTEM_CONFIG" "$REPO_CONFIG"

  # Sanitize: replace expanded secrets with env var placeholders
  if [[ -n "${S_LITELLM_API_KEY:-}" ]]; then
    sed -i "s|${S_LITELLM_API_KEY}|\${S_LITELLM_API_KEY}|g" "$REPO_CONFIG"
  fi
  if [[ -n "${OPENCLAW_GATEWAY_TOKEN:-}" ]]; then
    sed -i "s|${OPENCLAW_GATEWAY_TOKEN}|\${OPENCLAW_GATEWAY_TOKEN}|g" "$REPO_CONFIG"
  fi
  if [[ -n "${S_DISCORD_BOT_TOKEN:-}" ]]; then
    sed -i "s|${S_DISCORD_BOT_TOKEN}|\${S_DISCORD_BOT_TOKEN}|g" "$REPO_CONFIG"
  fi

  # Strip runtime-only fields (meta, wizard) and add example comment
  python3 -c "
import json, collections
with open('$REPO_CONFIG') as f:
    cfg = json.load(f)
cfg.pop('meta', None)
cfg.pop('wizard', None)
cfg.pop('_comment', None)
# Insert _comment at the top
ordered = collections.OrderedDict()
ordered['_comment'] = 'EXAMPLE CONFIG - For reference only. Actual config is at ~/.openclaw/openclaw.json. Sensitive values use \${ENV_VAR} placeholders.'
ordered.update(cfg)
with open('$REPO_CONFIG', 'w') as f:
    json.dump(ordered, f, indent=2)
    f.write('\n')
" 2>/dev/null || echo "‚ö†Ô∏è  Python cleanup skipped"

  # Re-stage if it was already staged
  if git diff --cached --name-only | grep -q "$REPO_CONFIG"; then
    git add "$REPO_CONFIG"
    echo "‚úÖ OpenClaw config synced, sanitized, and re-staged"
  fi
fi

# ==================== Gitleaks Secret Scanning ====================

echo ""
echo "üîç Scanning for secrets with Gitleaks..."

# Run gitleaks on staged files
if gitleaks protect --staged --verbose --redact 2>&1 | tee /tmp/gitleaks-output.txt; then
  echo "‚úÖ No secrets detected by Gitleaks"
else
  echo ""
  echo "‚ùå SECRETS DETECTED!"
  echo ""
  echo "Gitleaks found potential secrets in your staged files."
  echo "Please review the findings above and:"
  echo "  1. Remove the secrets from your code"
  echo "  2. Use environment variables instead: \${VARIABLE_NAME}"
  echo "  3. Add false positives to .gitleaksignore if needed"
  echo ""
  echo "To bypass this check (NOT recommended):"
  echo "  git commit --no-verify"
  echo ""
  exit 1
fi

echo ""
echo "‚úÖ All pre-commit checks passed!"
